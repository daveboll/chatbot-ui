<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .chat-bubble {
            max-width: 16rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }
        
        .chat-bubble-user {
            background-color: #2563eb;
            color: white;
            margin-left: auto;
        }
        
        .chat-bubble-bot {
            background-color: #f3f4f6;
            color: #111827;
        }
        
        .chat-bubble-option {
            background-color: white;
            border: 1px solid #d1d5db;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .chat-bubble-option:hover {
            background-color: #f9fafb;
        }
        
        .fault-status-in-progress {
            background-color: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .fault-status-ruled-out {
            background-color: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }
        
        .fault-status-root-cause {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Faster tooltip display */
        [title]:hover::after {
            animation: none;
            transition-delay: 0.1s;
        }
        

    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Left Panel - Case Navigation -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-xl font-semibold text-gray-900 mb-4">Cases</h1>
                
                <!-- Search Bar -->
                <div class="relative">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input
                        type="text"
                        id="caseSearch"
                        placeholder="Search cases..."
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
            </div>

            <!-- Cases List -->
            <div class="flex-1 overflow-y-auto flex flex-col" id="casesList">
                <!-- Open Cases Accordion -->
                <div class="border-b border-gray-200 flex-shrink-0">
                    <button class="w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="toggleAccordion('openCases')">
                        <div class="flex items-center space-x-2">
                            <svg class="h-4 w-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-medium text-gray-900">Open Cases</span>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full" id="openCasesCount">0</span>
                        </div>
                        <svg class="h-4 w-4 text-gray-500 transform transition-transform" id="openCasesIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="overflow-y-auto" id="openCasesContent" style="max-height: calc(100vh - 300px);">
                        <!-- Open cases will be populated here -->
                    </div>
                </div>

                <!-- Resolved Cases Accordion -->
                <div class="border-b border-gray-200 flex-shrink-0">
                    <button class="w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="toggleAccordion('resolvedCases')">
                        <div class="flex items-center space-x-2">
                            <svg class="h-4 w-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="font-medium text-gray-900">Resolved Cases</span>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full" id="resolvedCasesCount">0</span>
                        </div>
                        <svg class="h-4 w-4 text-gray-500 transform transition-transform" id="resolvedCasesIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="overflow-y-auto hidden" id="resolvedCasesContent" style="max-height: calc(100vh - 300px);">
                        <!-- Resolved cases will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-200">
                <div class="text-sm text-gray-500" id="caseCount">
                    5 cases found
                </div>
            </div>
        </div>

        <!-- Middle Panel - Chat Interface -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200 bg-white" id="chatHeader">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">Select a case to start chatting</h2>
                        <p class="text-sm text-gray-600"></p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800"></span>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messagesContainer">
                <div class="text-center text-gray-500 mt-8">
                    <svg class="h-12 w-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <p>Select a case to start chatting</p>
                </div>
            </div>

            <!-- Input -->
            <div class="p-4 border-t border-gray-200 bg-white">
                <div class="flex space-x-2">
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="Type your message..."
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        disabled
                    >
                    <button
                        id="sendButton"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                        disabled
                    >
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Panel - Fault Management -->
        <div class="w-96 bg-white border-l border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 mb-2">Fault Management</h2>
                <p class="text-sm text-gray-600">Track and manage identified faults</p>
            </div>

            <!-- Faults List -->
            <div class="flex-1 overflow-y-auto p-4" id="faultsContainer">
                <div class="text-center text-gray-500">
                    <svg class="h-12 w-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <p>Select a case to view faults</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="p-4 border-t border-gray-200 space-y-3">
                <button
                    id="createPassdownBtn"
                    class="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    disabled
                >
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Create Passdown</span>
                </button>
                
                        <button
            id="resolveCaseBtn"
            class="w-full flex items-center justify-center space-x-2 px-4 py-2 transition-colors rounded-lg"
            disabled
        >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="resolveCaseBtnText">Mark Case Resolved</span>
        </button>
            </div>
        </div>
    </div>

    <!-- Passdown Modal -->
    <div id="passdownModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-96 max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Create Passdown</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Summary
                    </label>
                    <textarea
                        id="passdownSummary"
                        rows="4"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Summarize the troubleshooting session..."
                    ></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Actions Taken
                    </label>
                    <textarea
                        id="passdownActions"
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="List the actions taken to resolve the issue..."
                    ></textarea>
                </div>
                
                <div class="flex space-x-3">
                    <button
                        id="cancelPassdownBtn"
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        id="savePassdownBtn"
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                        Save Passdown
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock data
        const mockCases = [
            {
                id: '1',
                number: 'CASE-001',
                title: 'Network Connectivity Issues',
                status: 'open',
                createdAt: '2024-01-15T10:30:00Z',
                updatedAt: '2024-01-15T14:45:00Z'
            },
            {
                id: '2',
                number: 'CASE-002',
                title: 'Database Performance Problems',
                status: 'open',
                createdAt: '2024-01-14T09:15:00Z',
                updatedAt: '2024-01-15T11:20:00Z'
            },
            {
                id: '3',
                number: 'CASE-003',
                title: 'Application Crashes',
                status: 'resolved',
                createdAt: '2024-01-13T16:45:00Z',
                updatedAt: '2024-01-14T10:30:00Z'
            },
            {
                id: '4',
                number: 'CASE-004',
                title: 'User Authentication Failures',
                status: 'open',
                createdAt: '2024-01-12T13:20:00Z',
                updatedAt: '2024-01-15T08:15:00Z'
            },
            {
                id: '5',
                number: 'CASE-005',
                title: 'API Response Time Issues',
                status: 'open',
                createdAt: '2024-01-11T11:00:00Z',
                updatedAt: '2024-01-15T12:30:00Z'
            }
        ];

        const mockFaults = [
            {
                id: '1',
                category: 'Network',
                symptom: 'Slow Connection',
                description: 'Network throughput is significantly below expected levels',
                status: 'in-progress',
                notes: 'Testing different network configurations'
            },
            {
                id: '2',
                category: 'Hardware',
                symptom: 'Router Issues',
                description: 'Router may be overheating or experiencing hardware failure',
                status: 'none',
                notes: ''
            },
            {
                id: '3',
                category: 'Configuration',
                symptom: 'DNS Problems',
                description: 'DNS resolution may be causing connection delays',
                status: 'ruled-out',
                notes: 'DNS settings verified and working correctly'
            },
            {
                id: '4',
                category: 'Software',
                symptom: 'Driver Issues',
                description: 'Network adapter drivers may be outdated or corrupted',
                status: 'none',
                notes: ''
            }
        ];

        let selectedCase = null;
        let currentChat = {
            id: '1',
            caseId: '1',
            messages: [
                {
                    id: '1',
                    type: 'bot',
                    content: 'Hello! I\'m here to help you troubleshoot your network connectivity issues. Can you tell me more about what you\'re experiencing?',
                    timestamp: '2024-01-15T10:30:00Z',
                    options: ['Slow connection', 'No connection', 'Intermittent drops', 'High latency']
                }
            ],
            createdAt: '2024-01-15T10:30:00Z',
            updatedAt: '2024-01-15T10:30:00Z'
        };

        // Initialize the application
        function init() {
            renderCases();
            setupEventListeners();
        }

        // Render cases in the left panel
        function renderCases() {
            const openCasesContent = document.getElementById('openCasesContent');
            const resolvedCasesContent = document.getElementById('resolvedCasesContent');
            const openCasesCount = document.getElementById('openCasesCount');
            const resolvedCasesCount = document.getElementById('resolvedCasesCount');
            const caseCount = document.getElementById('caseCount');
            
            // Separate cases by status
            const openCases = mockCases.filter(caseItem => caseItem.status === 'open');
            const resolvedCases = mockCases.filter(caseItem => caseItem.status === 'resolved');
            
            // Render open cases
            openCasesContent.innerHTML = openCases.map(caseItem => `
                <div class="p-2">
                    <div class="p-3 rounded-lg cursor-pointer transition-colors mb-2 hover:bg-gray-50 border border-transparent" 
                         onclick="selectCase('${caseItem.id}')">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-900">
                                    ${caseItem.number}
                                </span>
                                <svg class="h-4 w-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">
                                ${caseItem.status}
                            </span>
                        </div>
                        
                        <h3 class="text-sm font-medium text-gray-900 mb-1 line-clamp-2">
                            ${caseItem.title}
                        </h3>
                        
                        <div class="flex items-center text-xs text-gray-500">
                            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <span>Updated ${formatDate(caseItem.updatedAt)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Render resolved cases
            resolvedCasesContent.innerHTML = resolvedCases.map(caseItem => `
                <div class="p-2">
                    <div class="p-3 rounded-lg cursor-pointer transition-colors mb-2 hover:bg-gray-50 border border-transparent" 
                         onclick="selectCase('${caseItem.id}')">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-900">
                                    ${caseItem.number}
                                </span>
                                <svg class="h-4 w-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">
                                ${caseItem.status}
                            </span>
                        </div>
                        
                        <h3 class="text-sm font-medium text-gray-900 mb-1 line-clamp-2">
                            ${caseItem.title}
                        </h3>
                        
                        <div class="flex items-center text-xs text-gray-500">
                            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <span>Updated ${formatDate(caseItem.updatedAt)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update counts
            openCasesCount.textContent = openCases.length;
            resolvedCasesCount.textContent = resolvedCases.length;
            caseCount.textContent = `${mockCases.length} case${mockCases.length !== 1 ? 's' : ''} found`;
        }

        // Select a case
        function selectCase(caseId) {
            selectedCase = mockCases.find(c => c.id === caseId);
            updateChatHeader();
            renderMessages();
            renderFaults();
            enableInputs();
            
            // Ensure the appropriate accordion is open and case is selected
            ensureCaseSelected();
        }

        // Update chat header
        function updateChatHeader() {
            const chatHeader = document.getElementById('chatHeader');
            if (selectedCase) {
                chatHeader.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">${selectedCase.number}</h2>
                            <p class="text-sm text-gray-600">${selectedCase.title}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 text-xs rounded-full ${
                                selectedCase.status === 'resolved'
                                    ? 'bg-green-100 text-green-800'
                                    : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${selectedCase.status}
                            </span>
                        </div>
                    </div>
                `;
            }
        }

        // Render messages
        function renderMessages() {
            const messagesContainer = document.getElementById('messagesContainer');
            
            if (!selectedCase) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-gray-500 mt-8">
                        <svg class="h-12 w-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p>Select a case to start chatting</p>
                    </div>
                `;
                return;
            }

            if (currentChat.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-gray-500 mt-8">
                        <svg class="h-12 w-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p>Start a conversation to get help with your case</p>
                    </div>
                `;
                return;
            }

            messagesContainer.innerHTML = currentChat.messages.map(message => `
                <div class="flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="flex items-start space-x-2 max-w-xs lg:max-w-md">
                        ${message.type === 'bot' ? `
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                            </div>
                        ` : ''}
                        
                        <div class="flex flex-col">
                            <div class="chat-bubble ${message.type === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}">
                                <p class="text-sm">${message.content}</p>
                            </div>
                            
                            ${message.type === 'bot' && message.options ? `
                                <div class="mt-2 space-y-1">
                                    ${message.options.map(option => `
                                        <button onclick="selectOption('${option}')" class="chat-bubble-option text-sm text-left w-full">
                                            ${option}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${message.type === 'bot' ? `
                                <div class="flex items-center space-x-2 mt-2">
                                    <span class="text-xs text-gray-500">${formatTime(message.timestamp)}</span>
                                    <div class="flex space-x-1">
                                        <button onclick="giveFeedback('${message.id}', 'thumbs-up')" class="p-1 rounded hover:bg-gray-100 transition-colors text-gray-400">
                                            <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
                                            </svg>
                                        </button>
                                        <button onclick="giveFeedback('${message.id}', 'thumbs-down')" class="p-1 rounded hover:bg-gray-100 transition-colors text-gray-400">
                                            <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v2a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <div class="flex items-center justify-end mt-1">
                                    <span class="text-xs text-gray-500">${formatTime(message.timestamp)}</span>
                                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center ml-2">
                                        <svg class="h-4 w-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render faults
        function renderFaults() {
            const faultsContainer = document.getElementById('faultsContainer');
            
            if (!selectedCase) {
                faultsContainer.innerHTML = `
                    <div class="text-center text-gray-500">
                        <svg class="h-12 w-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <p>Select a case to view faults</p>
                    </div>
                `;
                return;
            }

            faultsContainer.innerHTML = `
                <div class="space-y-3">
                    ${mockFaults.map(fault => `
                        <div class="p-3 rounded-lg border ${getFaultStatusClass(fault.status)}">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    ${getFaultStatusIcon(fault.status)}
                                    <span class="text-sm font-medium text-gray-900">
                                        ${fault.category}
                                    </span>
                                </div>
                            </div>
                            
                            <h3 class="text-sm font-medium text-gray-900 mb-1">
                                ${fault.symptom}
                            </h3>
                            
                            <p class="text-xs text-gray-600 mb-3">
                                ${fault.description}
                            </p>
                            
                            <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded mb-3">
                                <div class="flex items-center justify-between mb-1">
                                    <strong>Notes:</strong>
                                    <button onclick="toggleNotesEdit('${fault.id}')" class="text-blue-600 hover:text-blue-800 text-xs">
                                        ${fault.notes ? 'Edit' : 'Add'} Notes
                                    </button>
                                </div>
                                <div id="notes-display-${fault.id}" class="${fault.notes ? '' : 'hidden'}">
                                    ${fault.notes || ''}
                                </div>
                                <div id="notes-edit-${fault.id}" class="${fault.notes ? 'hidden' : ''}">
                                    <textarea 
                                        id="notes-input-${fault.id}"
                                        class="w-full p-1 text-xs border border-gray-300 rounded resize-none"
                                        rows="2"
                                        placeholder="Add notes about this fault..."
                                    >${fault.notes || ''}</textarea>
                                    <div class="flex space-x-1 mt-1">
                                        <button onclick="saveNotes('${fault.id}')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">
                                            Save
                                        </button>
                                        <button onclick="cancelNotesEdit('${fault.id}')" class="text-xs bg-gray-300 text-gray-700 px-2 py-1 rounded hover:bg-gray-400">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Status buttons - moved to bottom to avoid blocking text -->
                            <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                                <div class="flex space-x-1">
                                    <button onclick="updateFaultStatus('${fault.id}', 'in-progress')" 
                                            class="p-2 rounded border transition-colors ${
                                                fault.status === 'in-progress'
                                                    ? 'bg-yellow-100 border-yellow-300 text-yellow-800'
                                                    : 'bg-white border-gray-300 text-gray-600 hover:bg-yellow-50'
                                            }"
                                            title="Mark as In Progress">
                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </button>
                                    
                                    <button onclick="updateFaultStatus('${fault.id}', 'ruled-out')" 
                                            class="p-2 rounded border transition-colors ${
                                                fault.status === 'ruled-out'
                                                    ? 'bg-green-100 border-green-300 text-green-800'
                                                    : 'bg-white border-gray-300 text-gray-600 hover:bg-green-50'
                                            }"
                                            title="Mark as Ruled Out">
                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </button>
                                    
                                    <button onclick="updateFaultStatus('${fault.id}', 'root-cause')" 
                                            class="p-2 rounded border transition-colors ${
                                                fault.status === 'root-cause'
                                                    ? 'bg-red-100 border-red-300 text-red-800'
                                                    : 'bg-white border-gray-300 text-gray-600 hover:bg-red-50'
                                            }"
                                            title="Mark as Root Cause">
                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Current Status Display -->
                                <div class="text-xs text-gray-500">
                                    ${fault.status === 'in-progress' ? 'In Progress' : 
                                      fault.status === 'ruled-out' ? 'Ruled Out' : 
                                      fault.status === 'root-cause' ? 'Root Cause' : 
                                      'Not Investigated'}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Utility functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getFaultStatusClass(status) {
            switch (status) {
                case 'in-progress': return 'fault-status-in-progress';
                case 'ruled-out': return 'fault-status-ruled-out';
                case 'root-cause': return 'fault-status-root-cause';
                default: return 'bg-white border-gray-200';
            }
        }

        function getFaultStatusIcon(status) {
            switch (status) {
                case 'in-progress':
                    return '<svg class="h-4 w-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                case 'ruled-out':
                    return '<svg class="h-4 w-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                case 'root-cause':
                    return '<svg class="h-4 w-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                default:
                    return '<svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>';
            }
        }

        function enableInputs() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('createPassdownBtn').disabled = false;
            document.getElementById('resolveCaseBtn').disabled = false;
            
            // Update resolve button based on case status
            const resolveBtn = document.getElementById('resolveCaseBtn');
            const resolveBtnText = document.getElementById('resolveCaseBtnText');
            const resolveBtnIcon = resolveBtn.querySelector('svg');
            
            if (selectedCase.status === 'resolved') {
                // Case is resolved - show "Mark as Open" button
                resolveBtn.className = 'w-full flex items-center justify-center space-x-2 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors';
                resolveBtnText.textContent = 'Mark Case as Open';
                resolveBtnIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            } else {
                // Case is open - show "Mark as Resolved" button
                resolveBtn.className = 'w-full flex items-center justify-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors';
                resolveBtnText.textContent = 'Mark Case as Resolved';
                resolveBtnIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
            }
        }

        // Event handlers
        function selectOption(option) {
            const userMessage = {
                id: Date.now().toString(),
                type: 'user',
                content: option,
                timestamp: new Date().toISOString()
            };

            currentChat.messages.push(userMessage);

            // Simulate bot response
            setTimeout(() => {
                const botResponse = {
                    id: (Date.now() + 1).toString(),
                    type: 'bot',
                    content: `Thank you for selecting "${option}". I'm processing your request and will provide a response shortly.`,
                    timestamp: new Date().toISOString(),
                    options: ['Continue troubleshooting', 'Request more information', 'Mark as resolved']
                };

                currentChat.messages.push(botResponse);
                renderMessages();
            }, 1000);

            renderMessages();
        }

        function giveFeedback(messageId, feedback) {
            // In a real app, you would send this to your backend
            console.log(`Feedback for message ${messageId}: ${feedback}`);
        }

        function updateFaultStatus(faultId, status) {
            const fault = mockFaults.find(f => f.id === faultId);
            if (fault) {
                // If clicking the same status, revert to "none"
                if (fault.status === status) {
                    fault.status = 'none';
                } else {
                    fault.status = status;
                }
                renderFaults();
            }
        }

        function toggleNotesEdit(faultId) {
            const displayDiv = document.getElementById(`notes-display-${faultId}`);
            const editDiv = document.getElementById(`notes-edit-${faultId}`);
            const input = document.getElementById(`notes-input-${faultId}`);
            
            if (displayDiv.classList.contains('hidden')) {
                // Switch to display mode
                displayDiv.classList.remove('hidden');
                editDiv.classList.add('hidden');
            } else {
                // Switch to edit mode
                displayDiv.classList.add('hidden');
                editDiv.classList.remove('hidden');
                input.focus();
            }
        }

        function saveNotes(faultId) {
            const fault = mockFaults.find(f => f.id === faultId);
            const input = document.getElementById(`notes-input-${faultId}`);
            const displayDiv = document.getElementById(`notes-display-${faultId}`);
            const editDiv = document.getElementById(`notes-edit-${faultId}`);
            
            if (fault) {
                fault.notes = input.value.trim();
                displayDiv.textContent = fault.notes;
                displayDiv.classList.remove('hidden');
                editDiv.classList.add('hidden');
                renderFaults();
            }
        }

        function cancelNotesEdit(faultId) {
            const fault = mockFaults.find(f => f.id === faultId);
            const input = document.getElementById(`notes-input-${faultId}`);
            const displayDiv = document.getElementById(`notes-display-${faultId}`);
            const editDiv = document.getElementById(`notes-edit-${faultId}`);
            
            // Reset input to original value
            input.value = fault.notes || '';
            displayDiv.classList.remove('hidden');
            editDiv.classList.add('hidden');
        }

        function toggleAccordion(section) {
            const openContent = document.getElementById('openCasesContent');
            const resolvedContent = document.getElementById('resolvedCasesContent');
            const openIcon = document.getElementById('openCasesIcon');
            const resolvedIcon = document.getElementById('resolvedCasesIcon');
            
            if (section === 'openCases') {
                if (openContent.classList.contains('hidden')) {
                    // Expand open cases, collapse resolved cases
                    openContent.classList.remove('hidden');
                    resolvedContent.classList.add('hidden');
                    openIcon.style.transform = 'rotate(180deg)';
                    resolvedIcon.style.transform = 'rotate(0deg)';
                } else {
                    // Collapse open cases
                    openContent.classList.add('hidden');
                    openIcon.style.transform = 'rotate(0deg)';
                }
            } else if (section === 'resolvedCases') {
                if (resolvedContent.classList.contains('hidden')) {
                    // Expand resolved cases, collapse open cases
                    resolvedContent.classList.remove('hidden');
                    openContent.classList.add('hidden');
                    resolvedIcon.style.transform = 'rotate(180deg)';
                    openIcon.style.transform = 'rotate(0deg)';
                } else {
                    // Collapse resolved cases
                    resolvedContent.classList.add('hidden');
                    resolvedIcon.style.transform = 'rotate(0deg)';
                }
            }
        }
        
        function ensureCaseSelected() {
            if (!selectedCase) return;
            
            // Find and select the case in the appropriate accordion
            const caseElements = document.querySelectorAll('#openCasesContent > div > div, #resolvedCasesContent > div > div');
            caseElements.forEach(el => {
                el.classList.remove('bg-blue-50', 'border-blue-200');
                el.classList.add('hover:bg-gray-50', 'border-transparent');
            });
            
            // Find the specific case element and select it
            const targetCaseElement = Array.from(caseElements).find(el => {
                const onclick = el.getAttribute('onclick');
                return onclick && onclick.includes(selectedCase.id);
            });
            
            if (targetCaseElement) {
                targetCaseElement.classList.remove('hover:bg-gray-50', 'border-transparent');
                targetCaseElement.classList.add('bg-blue-50', 'border-blue-200');
            }
        }

        function setupEventListeners() {
            // Send message
            document.getElementById('sendButton').addEventListener('click', () => {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                
                if (message && selectedCase) {
                    const userMessage = {
                        id: Date.now().toString(),
                        type: 'user',
                        content: message,
                        timestamp: new Date().toISOString()
                    };

                    currentChat.messages.push(userMessage);
                    input.value = '';
                    renderMessages();

                    // Simulate bot response
                    setTimeout(() => {
                        const botResponse = {
                            id: (Date.now() + 1).toString(),
                            type: 'bot',
                            content: 'Thank you for your message. I\'m processing your request and will provide a response shortly.',
                            timestamp: new Date().toISOString(),
                            options: ['Continue troubleshooting', 'Request more information', 'Mark as resolved']
                        };

                        currentChat.messages.push(botResponse);
                        renderMessages();
                    }, 1000);
                }
            });

            // Enter key to send message
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('sendButton').click();
                }
            });

            // Case search
            document.getElementById('caseSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredCases = mockCases.filter(caseItem => 
                    caseItem.number.toLowerCase().includes(searchTerm) ||
                    caseItem.title.toLowerCase().includes(searchTerm)
                );
                
                // Update the display with filtered cases
                // This is a simplified version - in a real app you'd re-render the cases list
                console.log('Searching for:', searchTerm, 'Found:', filteredCases.length);
            });

            // Passdown modal
            document.getElementById('createPassdownBtn').addEventListener('click', () => {
                document.getElementById('passdownModal').classList.remove('hidden');
                
                // Auto-generate summary from chat
                if (currentChat.messages.length > 0) {
                    const lastMessages = currentChat.messages.slice(-3);
                    const summary = lastMessages.map(msg => msg.content).join('. ');
                    document.getElementById('passdownSummary').value = summary;
                }
            });

            document.getElementById('cancelPassdownBtn').addEventListener('click', () => {
                document.getElementById('passdownModal').classList.add('hidden');
            });

            document.getElementById('savePassdownBtn').addEventListener('click', () => {
                const summary = document.getElementById('passdownSummary').value;
                const actions = document.getElementById('passdownActions').value;
                
                console.log('Saving passdown:', { summary, actions });
                document.getElementById('passdownModal').classList.add('hidden');
                
                // Clear the form
                document.getElementById('passdownSummary').value = '';
                document.getElementById('passdownActions').value = '';
            });

            // Resolve/Open case
            document.getElementById('resolveCaseBtn').addEventListener('click', () => {
                if (selectedCase) {
                    const newStatus = selectedCase.status === 'resolved' ? 'open' : 'resolved';
                    const statusText = newStatus === 'resolved' ? 'resolved' : 'open';
                    
                    console.log(`Marking case as ${statusText}:`, selectedCase.id);
                    
                    // Update the case status
                    selectedCase.status = newStatus;
                    selectedCase.updatedAt = new Date().toISOString();
                    
                    // Update the mock cases array
                    const caseIndex = mockCases.findIndex(c => c.id === selectedCase.id);
                    if (caseIndex !== -1) {
                        mockCases[caseIndex] = { ...selectedCase };
                    }
                    
                    // Re-render all panels to reflect the change
                    renderCases();
                    updateChatHeader();
                    enableInputs(); // Update button styling
                    
                    // Determine which accordion should be open based on case status
                    const targetSection = selectedCase.status === 'resolved' ? 'resolvedCases' : 'openCases';
                    
                    // Open the appropriate accordion
                    toggleAccordion(targetSection);
                    
                    // Ensure the case is selected in the new accordion
                    ensureCaseSelected();
                    
                    alert(`Case marked as ${statusText}!`);
                }
            });
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
